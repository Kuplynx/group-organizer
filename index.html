<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Group Organizer</title>
    <script src="tailwind.js"></script>
</head>

<body class="bg-gray-50 min-h-screen p-4 md:p-8">
    <div class="max-w-4xl mx-auto bg-white shadow-lg rounded-xl overflow-hidden">

        <div class="bg-indigo-600 p-6 text-white">
            <h1 class="text-2xl font-bold" id="mainTitle">Group Organizer</h1>
            <p class="text-indigo-100 text-sm">Manage student history and generate new groups.</p>
        </div>

        <div class="p-6 space-y-8">
            <section class="grid grid-cols-2 md:grid-cols-2 gap-4 bg-indigo-50 p-4 rounded-lg">
                <div>
                    <label class="block text-sm font-semibold text-gray-700">Group Size</label>
                    <input type="number" id="groupSize" value="4" class="w-full mt-1 p-2 border rounded">
                </div>
                <div>
                    <label class="block text-sm font-semibold text-gray-700">Number of Groups</label>
                    <input type="number" id="numGroups" value="6" class="w-full mt-1 p-2 border rounded">
                </div>
                <div>
                    <label class="block text-sm font-semibold text-gray-700">Class Name</label>
                    <input type="text" id="schoolClassName" value="AP Seminar" class="w-full mt-1 p-2 border rounded">
                </div>
                <div>
                    <label class="block text-sm font-semibold text-gray-700">Period</label>
                    <input type="text" id="period" value="5" class="w-full mt-1 p-2 border rounded">
                </div>

            </section>

            <section>
                <div class="flex justify-between items-center mb-4">
                    <h2 class="text-xl font-bold text-gray-800">Student Roster</h2>
                    <button onclick="addStudent()"
                        class="bg-green-600 hover:bg-green-700 text-white px-4 py-2 rounded-lg text-sm transition">
                        + Add Student
                    </button>
                </div>

                <div id="rosterContainer" class="space-y-4">
                </div>
            </section>

            <section class="border-t pt-6 flex flex-wrap gap-3">
                <button onclick="downloadJSON()"
                    class="bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded shadow">
                    Download History (.json)
                </button>
                <label class="bg-gray-200 hover:bg-gray-300 px-4 py-2 rounded cursor-pointer shadow">
                    Upload History
                    <input type="file" id="uploadInput" class="hidden" accept=".json" onchange="uploadJSON(event)">
                </label>
                <button onclick="submitToAPI()"
                    class="bg-indigo-600 hover:bg-indigo-700 text-white px-4 py-2 rounded shadow ml-auto">
                    Compute Groups â†’
                </button>
            </section>
        </div>
    </div>
    <div id="groupModal"
        class="hidden fixed inset-0 bg-gray-900 bg-opacity-50 flex items-center justify-center p-4 z-50">
        <div class="bg-white rounded-xl shadow-2xl max-w-lg w-full max-h-[80vh] flex flex-col">
            <div class="p-6 border-b">
                <h2 class="text-xl font-bold text-gray-800">Proposed Groups</h2>
                <div
                    class="grid grid-cols-3 gap-2 mt-3 py-2 px-3 bg-gray-50 rounded-lg border border-gray-100 text-center">
                    <div>
                        <p class="text-[10px] uppercase tracking-wider text-gray-500 font-bold">Backtracks</p>
                        <p id="statBacktracks" class="text-lg font-mono font-bold text-indigo-600">0</p>
                    </div>
                    <div>
                        <p class="text-[10px] uppercase tracking-wider text-gray-500 font-bold">Attempts (Million)</p>
                        <p id="statAttempts" class="text-lg font-mono font-bold text-indigo-600">0</p>
                    </div>
                    <div>
                        <p class="text-[10px] uppercase tracking-wider text-gray-500 font-bold">Time (s)</p>
                        <p id="statTime" class="text-lg font-mono font-bold text-indigo-600">0.00</p>
                    </div>
                </div>
            </div>

            <div id="modalContent" class="p-6 overflow-y-auto flex-grow space-y-4">
            </div>

            <div class="p-6 border-t bg-gray-50 flex flex-col sm:flex-row gap-3">
                <button onclick="closeModal()"
                    class="flex-1 px-4 py-2 border border-gray-300 rounded-lg hover:bg-gray-100 transition text-sm font-semibold">
                    Discard & Try Again
                </button>
                <button onclick="confirmAndDownload()"
                    class="flex-1 px-4 py-2 bg-indigo-600 text-white rounded-lg hover:bg-indigo-700 shadow-md transition text-sm font-semibold">
                    Accept & Save State
                </button>
            </div>
        </div>
    </div>
    <div id="errorModal"
        class="hidden fixed inset-0 bg-gray-900 bg-opacity-50 flex items-center justify-center p-4 z-[60]">
        <div class="bg-white rounded-xl shadow-2xl max-w-sm w-full overflow-hidden">
            <div class="bg-red-50 p-6 flex flex-col items-center">
                <div class="w-12 h-12 bg-red-100 rounded-full flex items-center justify-center mb-4">
                    <svg class="w-6 h-6 text-red-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                            d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 17c-.77 1.333.192 3 1.732 3z" />
                    </svg>
                </div>
                <h2 class="text-lg font-bold text-gray-900">Invalid Settings</h2>
                <p id="errorMessage" class="text-sm text-gray-600 text-center mt-2">
                    Please check your group configuration and try again.
                </p>
            </div>
            <div class="p-4 bg-gray-50 flex justify-center">
                <button onclick="closeErrorModal()"
                    class="w-full py-2 bg-gray-800 text-white rounded-lg hover:bg-gray-900 transition font-medium">
                    Got it
                </button>
            </div>
        </div>
    </div>
    <div id="infoModal"
        class="hidden fixed inset-0 bg-gray-900 bg-opacity-50 flex items-center justify-center p-4 z-[70]">
        <div class="bg-white rounded-xl shadow-2xl max-w-sm w-full overflow-hidden">
            <div class="bg-blue-50 p-6 flex flex-col items-center">
                <div class="w-12 h-12 bg-blue-100 rounded-full flex items-center justify-center mb-4">
                    <svg class="w-6 h-6 text-blue-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                            d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z" />
                    </svg>
                </div>
                <h2 id="infoTitle" class="text-lg font-bold text-gray-900">Success</h2>
                <p id="infoMessage" class="text-sm text-gray-600 text-center mt-2">
                    Action completed successfully.
                </p>
            </div>
            <div class="p-4 bg-gray-50 flex justify-center">
                <button id="infoModalButton" onclick="closeInfoModal()"
                    class="w-full py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 transition font-medium">
                    Continue
                </button>
            </div>
        </div>
    </div>

    <script>
        // fetch API version from "/version"
        fetch('/version')
            .then(response => response.text())
            .then(version => {
                document.getElementById('mainTitle').innerText = `Group Organizer ${version.replaceAll("\"", "")}`;
            })
            .catch(error => {
                console.error('Error fetching version:', error);
            });


        let students = {};

        // 1. Core Logic: Add Student
        function addStudent() {
            const name = prompt("Enter student name:");
            if (name && !students[name]) {
                students[name] = [];
                render();
            }
        }

        // 2. Core Logic: Manage Partners (Auto-filling gaps)
        function togglePartner(studentName, partnerName) {
            if (studentName === partnerName) return;

            // Add/Remove for the primary student
            if (students[studentName].includes(partnerName)) {
                students[studentName] = students[studentName].filter(p => p !== partnerName);
                // Auto-remove the reverse link
                students[partnerName] = students[partnerName].filter(p => p !== studentName);
            } else {
                students[studentName].push(partnerName);
                // Auto-add the reverse link
                if (!students[partnerName].includes(studentName)) {
                    students[partnerName].push(studentName);
                }
            }
            render();
        }

        // 3. UI Rendering
        function render() {
            const container = document.getElementById('rosterContainer');
            container.innerHTML = '';
            const allNames = Object.keys(students);

            allNames.forEach(name => {
                const card = document.createElement('div');
                card.className = "border rounded-lg p-4 bg-white shadow-sm";

                let partnerCheckboxes = allNames
                    .filter(n => n !== name)
                    .map(n => `
                        <label class="inline-flex items-center mr-4 mb-2 text-sm bg-gray-50 px-2 py-1 rounded border">
                            <input type="checkbox" class="mr-2" ${students[name].includes(n) ? 'checked' : ''} 
                                onchange="togglePartner('${name}', '${n}')">
                            ${n}
                        </label>
                    `).join('');

                card.innerHTML = `
                    <div class="flex justify-between mb-3 border-b pb-2">
                        <span class="font-bold text-indigo-800">${name}</span>
                        <button onclick="deleteStudent('${name}')" class="text-red-500 text-xs">Remove</button>
                    </div>
                    <div class="text-gray-600 text-xs mb-2 font-semibold">PAST PARTNERS:</div>
                    <div class="flex flex-wrap">${partnerCheckboxes || '<span class="text-gray-400 italic text-sm">No other students yet</span>'}</div>
                `;
                container.appendChild(card);
            });
        }

        function deleteStudent(name) {
            delete students[name];
            // Cleanup references
            Object.keys(students).forEach(key => {
                students[key] = students[key].filter(p => p !== name);
            });
            render();
        }

        // 4. File Handling
        function downloadJSON() {
            const period = document.getElementById('period').value;
            const className = document.getElementById('schoolClassName').value;
            const groupSize = document.getElementById('groupSize').value;
            const numGroups = document.getElementById('numGroups').value;
            const dataBody = { "map": students, "class_name": className, "period": period, "group_size": groupSize, "num_groups": numGroups };
            const dataStr = "data:text/json;charset=utf-8," + encodeURIComponent(JSON.stringify(dataBody, null, 2));
            const filename = `student_partners_${className.replaceAll(" ", "_")}_Period_${period}.json`;
            const downloadAnchorNode = document.createElement('a');
            downloadAnchorNode.setAttribute("href", dataStr);
            downloadAnchorNode.setAttribute("download", filename);
            document.body.appendChild(downloadAnchorNode);
            downloadAnchorNode.click();
            downloadAnchorNode.remove();
        }

        function uploadJSON(event) {
            const file = event.target.files[0];
            const reader = new FileReader();
            reader.onload = (e) => {
                try {
                    data = JSON.parse(e.target.result);
                    students = data.map || {};
                    document.getElementById('schoolClassName').value = data.class_name || "AP Seminar";
                    document.getElementById('period').value = data.period || "5";
                    document.getElementById('groupSize').value = data.group_size || 4;
                    document.getElementById('numGroups').value = data.num_groups || 6;
                    render();
                    showInfo("Success", "Student history loaded successfully!");
                } catch (err) { showError("Invalid JSON file"); }
            };
            reader.readAsText(file);
        }

        // 5. API Submission
        let lastPendingGroups = [];
        async function submitToAPI() {
            const groupSize = document.getElementById('groupSize').value;
            const numGroups = document.getElementById('numGroups').value;
            const studentCount = Object.keys(students).length;

            if (studentCount === 0) {
                showError("Your roster is empty. Please add students first!");
                return;
            }

            if (groupSize <= 0 || numGroups <= 0) {
                showError("Group size and number of groups must be greater than zero.");
                return;
            }

            if (numGroups > studentCount) {
                showError(`You requested ${numGroups} groups, but you only have ${studentCount} students.`);
                return;
            }
            // check if we are on localhost or 127.0.0.1
            const host = window.location.hostname;
            const url = `http://${host}:3651/compute/${groupSize}/${numGroups}`;
            real_resp = { "map": students }
            showInfo("Notice", "Computing groups. This is a computationally expensive task and may take some time. Please be patient!");
            document.getElementById('infoModalButton').style.display = 'none';
            document.getElementById("infoModalButton").disabled = true;
            try {
                const response = await fetch(url, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(real_resp)
                });
                const result = await response.json();
                closeInfoModal();
                document.getElementById('infoModalButton').style.display = 'block';
                document.getElementById("infoModalButton").disabled = false;
                console.log(result);
                if (result.attempts_made === 0) {
                    showError("No valid groups could be formed with the current constraints. Please adjust group size or number of groups.");
                    return;
                }
                else if (result.attempts_made >= (2 ** 36)) {
                    showError(`Computation exceeded maximum allowed attempts (${result.attempts_made.toLocaleString()}). Please try different group settings.\n\nIf partners are not restrictive, then try again as it will likely find a solution. If this keeps happening, consider starting over as people may have too many past group members.`);
                    return;
                }
                console.log("Groups Generated:", result);
                lastPendingGroups = result.cover;
                showModal(lastPendingGroups, result.attempts_made, result.times_backtracked, result.time_taken_secs);
                // alert("Groups computed! Check console for results.");
            } catch (error) {
                console.error("Error:", error);
                showError("Failed to reach API.");
            }
        }
        function showError(message) {
            document.getElementById('errorMessage').innerText = message;
            document.getElementById('errorModal').classList.remove('hidden');
        }

        function closeErrorModal() {
            document.getElementById('errorModal').classList.add('hidden');
        }

        function showInfo(title, message) {
            document.getElementById('infoTitle').innerText = title;
            document.getElementById('infoMessage').innerText = message;
            document.getElementById('infoModal').classList.remove('hidden');
        }

        function closeInfoModal() {
            document.getElementById('infoModal').classList.add('hidden');
        }

        function showModal(groups, attempts, backtracks, time) {
            const modal = document.getElementById('groupModal');
            const content = document.getElementById('modalContent');
            const attempts_per_second = ((attempts / time) / 1_000_000).toFixed(0);
            document.getElementById('statBacktracks').innerText = backtracks;
            document.getElementById('statAttempts').innerText = `${(attempts / 1_000_000).toFixed(2)}M (${attempts_per_second}M /sec)`;
            document.getElementById('statTime').innerText = Number(time).toFixed(3);
            content.innerHTML = '';

            groups.forEach((group, index) => {
                const groupDiv = document.createElement('div');
                groupDiv.className = "p-3 bg-indigo-50 rounded-lg border border-indigo-100";
                groupDiv.innerHTML = `
            <div class="font-bold text-indigo-800 text-xs mb-1">GROUP ${index + 1}</div>
            <div class="text-gray-700">${group.join(', ')}</div>
        `;
                content.appendChild(groupDiv);
            });

            modal.classList.remove('hidden');
        }

        function closeModal() {
            document.getElementById('groupModal').classList.add('hidden');
            lastPendingGroups = [];
        }

        function confirmAndDownload() {
            // 1. Update the state: Loop through each group
            lastPendingGroups.forEach(group => {
                group.forEach(studentName => {
                    // Add everyone else in the group as a partner
                    const partners = group.filter(p => p !== studentName);

                    partners.forEach(partner => {
                        if (!students[studentName].includes(partner)) {
                            students[studentName].push(partner);
                        }
                    });
                });
            });

            // 2. Refresh the UI table
            render();

            // 3. Close the popup
            closeModal();

            // 4. Trigger the download automatically
            downloadJSON();

            showInfo("Success", "History updated and file downloaded!\nSave this file for future use and ensure it is the latest version.");
        }
    </script>
</body>

</html>